<!DOCTYPE html>
<html>
<head>
<title>G</title>
<meta charset="UTF-8"/>
<script src="http://keyten.github.io/Graphics2D/Graphics2D.js"></script>
<script>
// Sprite
(function(window, $, undefined){

	$.Context.prototype.sprite = function(img, x, y, w, h){
		return this.push(new Sprite(img, x, y, w, h, this));
	};

	var Sprite = $.Sprite = $.Class($.Image, {
		initialize : function(){
			this._frames = [];
			this._sequences = [];
			this._image.onload = function(){ this.fire('load') }.bind(this);
		},
		autoslice : function(width, height){
			if(!this._image.complete)
				return this._image.addEventListener('load', function(){ this.autoslice(width, height)}.bind(this));
			var iw = this._image.width,
				ih = this._image.height;
			for(var j = 0; j < ih; j+=height){
				for(var i = 0; i < iw; i+=width){
					this._frames.push([i, j, width, height]);
				}
			}

			var s = this._computeSize(this._width, this._height, { width:width, height:height });
			this._width = s[0];
			this._height = s[1];

			return this;
		},
		slice : function(frame, slice,y,w,h){
			if(typeof frame == 'object' && 0 in frame){
				$.util.extend(this._frames, frame);
				return this;
			}
			else if(slice === undefined)
				return this._frames[frame];

			if(y !== undefined)
				slice = [slice, y, w, h];

			this._frames[frame] = slice;
			return this;
		},
		frame : function(frame){
			if(frame === undefined)
				return this._frame;

			if(!this._image.complete)
				return this._image.addEventListener('load', function(){ this.frame(frame)}.bind(this));

			this._frame = frame;
			this._crop = this._frames[frame];
//			this._visible = true;
			this.fire('frame', {frame:frame});
			return this.update();
		},
		nextframe : function(){
			return this.frame(this._frame === this._frames.length-1 ? 0 : this._frame + 1)
		},
		prevframe : function(){
			return this.frame(this._frame === 0 ? this._frames.length-1 : this._frame - 1)
		},

		sequence : function(name, frames){
			this._sequences[name] = frames;
		},
		play : function(sequence, fps, loop, callback){
			if(this._timer)
				window.clearInterval(this._timer);

			if($.util.isString(sequence))
				sequence = this._sequences[sequence];

			if(!fps)
				fps = 60;

			if(typeof loop == 'function')
				callback = loop,
				loop = true;

			if(loop === undefined)
				loop = true;

			if(callback === undefined)
				callback = emptyFunc;

			var i = 0;
			if(fps < 0){
				i = sequence.length-1;
				this._timer = window.setInterval(function(){
					if(i === 0)
						!loop ? callback.call(this.stop()) : ((i = sequence.length-1), callback.call(this));
					this.frame(sequence[i--]);
				}.bind(this), -fps);
			}
			else {
				this._timer = window.setInterval(function(){
					if(sequence.length === i)
						!loop ? callback.call(this.stop()) : ((i = 0), callback.call(this));
					this.frame(sequence[i++]);
				}.bind(this), fps);
			}
		},
		stop : function(){
			window.clearInterval(this._timer);
			return this;
		},

		_frame : null,
//		_visible : false
	});


	function emptyFunc(){}

})(window, Graphics2D);</script>
<script>
(function(window, $, undefined){

	var on = $.Context.prototype.on;
	$.Context.prototype.on = function(event, func, parameters){
		if(event == 'keypressed'){
			var keys = {};
			this.on('keydown', function(e){
				if(keys[e.which])
					return;
				keys[e.which] = true;
				this.fire('keypressed', e);
			});
			this.on('keyup', function(e){
				keys[e.which] = false;
			});
		}
		return on.call(this, event, func);
	}

})(window, Graphics2D);
</script>
</head>
<body onload="document.getElementById('ctx').focus();">
<canvas id="ctx" tabindex="1" style="background:#fefefe;border:solid 1px #eee;" width="768" height="451"></canvas>
<script>

	var ctx = Graphics2D.id('ctx');
	var bg = ctx.image("BG-armory.png",0,0);
	var position = [350, 255]
	var stand = ctx.sprite('stand.png', position[0], position[1], 98, 156);
	stand.autoslice(98, 156);
	stand.frame(0);
	stand.sequence('stand', [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20]);
	stand.play('stand');

	var block = ctx.sprite('block.png', position[0]-10, position[1]-9, 114, 173);
	block.autoslice(114, 173);
	block.frame(0);
	block.sequence('block', [0,1,2,3]);
	block.hide();
	block.scale(0.95)

	var bwalk = ctx.sprite('blockwalk.png', position[0]-10, position[1]-10, 582 / 6, 492 / 3);
	bwalk.autoslice(582 / 6, 492 / 3);
	bwalk.frame(0);
	bwalk.sequence('walk', [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17]);
	bwalk.hide();

	var run = ctx.sprite('run.png', position[0], position[1] + 9, 114, 140);
	run.autoslice(114, 140);
	run.frame(0);
	run.sequence('runstart', [0,1,2,3,4,5,6]);
	run.sequence('run', [7,8,9,10,11,12,13,14,15,16,17]);
	run.sequence('runend', [18,19,20,21]);
	run.hide();

// proxy :)
	Graphics2D.Shape.prototype.show = function(){
		this._x = position[0];
		this._visible = true;
		return this.update();
	}

	ctx.on('keypressed', function(e){
		if(e.which == 83){ // block
			if(stand._visible){
				stand.stop();
				stand.hide();
				block.play('block', 60, false);
				block.show();
			}
			else {
				// run
				run.play('runend', 60, false, function(){
					run.hide();
					stopMoveChar();
					bwalk.play('walk');
					bwalk.show();
					startMoveChar(1, bwalk);
				});
			}
		}
		if(e.which == 68){ // right
			if(block._visible){
				block.hide();
				bwalk.play('walk');
				bwalk.show();
				startMoveChar(1, bwalk);
			}
			else {
				stand.hide();
				run.play('runstart', 20, false, function(){
					run.play('run');
					startMoveChar(3.5, run);
				});
				run.show();
			}
		}
	});
	ctx.on('keyup', function(e){
		if(e.which == 83){ // unblock
			if(block._visible){
				block.stop();
				block.play('block', -60, false, function(){
					setTimeout(function(){
						block.hide();
						stand.play('stand');
						stand.show();
					},100);
				});
			}
			else if(bwalk._visible){
				bwalk.stop();
				bwalk.hide();
				run.play('runstart', 20, false, function(){
					run.play('run');
					startMoveChar(3.5, run);
				});
				run.show();
				stopMoveChar();
			}
		}
		else if(e.which == 68){
			if(bwalk._visible){
				bwalk.stop();
				bwalk.hide();
				block.play([2,3], 60, false);
				block.show();
				stopMoveChar();
			}
			else {
				run.play('runend', 60, false, function(){
					run.hide();
					stopMoveChar();
					stand.play('stand');
					stand.show();
				});
			}
		}
	});

	var interval;
	function startMoveChar(speed, char){
		interval = window.setInterval(function(){
			if(position[0] >= 900)
				position[0] = -50;
			position[0] += speed;
			char._x = position[0];
		}, 10);
	}
	function stopMoveChar(){
		position[0] -= 10;
		window.clearInterval(interval);
	}

	// callback с зацикленным - не работает
	// 

</script>
</body>
</html>